<div class="container-fluid app-container p-0">
    <!-- Loading -->
    @if (loading) {
    <div class="d-flex flex-column align-items-center justify-content-center min-vh-50 mt-5">
        <app-loading></app-loading>
        <p class="text-muted mt-3">Loading live data...</p>
    </div>
    }

    <!-- Error -->
    @if (error) {
    <div class="container mt-4">
        <app-error [httpErrorResponse]="error"></app-error>
    </div>
    }

    @if (!loading && stop) {
    <!-- HEADER SECTION -->
    <header class="bg-white shadow-sm mb-4 pt-4 pb-3">
        <div class="container-xl">
            <div class="row g-4">
                <!-- Info Column -->
                <div class="col-lg-8">

                    <!-- 1. TITLE ROW -->
                    <h1 class="display-5 fw-bold mb-2 text-dark">{{ stop.name }}</h1>

                    <!-- 2. METADATA ROW (Badges & Type) -->
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        <span class="badge rounded-pill d-flex align-items-center gap-2 px-3 py-2"
                            [class.bg-primary]="stop.stopType?.includes('Bus')"
                            [class.bg-success]="stop.stopType?.includes('Tram')"
                            [class.bg-warning]="stop.stopType?.includes('Metro')"
                            [class.text-dark]="stop.stopType?.includes('Metro')"
                            [class.bg-info]="stop.stopType?.includes('Rail') || stop.stopType?.includes('Train')"
                            [class.bg-secondary]="!stop.stopType">
                            <i class="bi {{ getStopTypeIcon(stop.stopType) }}"></i>
                            <span class="text-uppercase tracking-wider">{{ stop.stopType }}</span>
                        </span>

                        @if(stop.zone) {
                        <span class="badge bg-light text-dark border px-3 py-2">Zone {{ stop.zone }}</span>
                        }
                    </div>

                    <p class="text-muted fs-6 mb-4" style="max-width: 600px;">{{ stop.description }}</p>

                    <!-- 3. ACTIONS ROW (Buttons) -->
                    <div class="d-flex flex-wrap gap-3 border-top pt-3">

                        <!-- A. Toggle Routes -->
                        @if (stop.routes?.length) {
                        <button class="btn btn-sm btn-outline-primary fw-bold d-flex align-items-center gap-2"
                            (click)="isRoutesCollapsed = !isRoutesCollapsed" [attr.aria-expanded]="!isRoutesCollapsed"
                            [class.active]="!isRoutesCollapsed">
                            <i class="bi bi-signpost-split"></i>
                            {{ isRoutesCollapsed ? 'View' : 'Hide' }} {{ stop.routes?.length }} Routes
                            <i class="bi" [class.bi-chevron-down]="isRoutesCollapsed"
                                [class.bi-chevron-up]="!isRoutesCollapsed"></i>
                        </button>
                        }

                        <!-- B. Toggle Data Sources -->
                        <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2"
                            (click)="isSourcesCollapsed = !isSourcesCollapsed"
                            [attr.aria-expanded]="!isSourcesCollapsed" [class.active]="!isSourcesCollapsed">
                            <i class="bi bi-database"></i>
                            Data Sources
                            <i class="bi" [class.bi-chevron-down]="isSourcesCollapsed"
                                [class.bi-chevron-up]="!isSourcesCollapsed"></i>
                        </button>
                    </div>

                    <!-- 4. EXPANDABLE PANELS -->

                    <!-- Routes Panel -->
                    <div #collapseRoutes="ngbCollapse" [ngbCollapse]="isRoutesCollapsed" class="mt-3">
                        <div class="card card-body bg-light border-0 shadow-sm">
                            <small class="text-uppercase text-muted fw-bold mb-2 d-block"
                                style="font-size: 0.7rem;">Available Lines</small>
                            <div class="d-flex flex-wrap gap-2">
                                @for (route of stop.routes; track route) {
                                <app-route [route]="route"></app-route>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Sources Panel -->
                    <div #collapseSources="ngbCollapse" [ngbCollapse]="isSourcesCollapsed" class="mt-3">
                        <div class="card card-body bg-light border-0 small">
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless mb-0 bg-transparent">
                                    <thead>
                                        <tr class="text-uppercase text-muted" style="font-size: 0.75rem;">
                                            <th>Provider</th>
                                            <th>Raw Name</th>
                                            <th>ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (ms of stop.mergedStops; track ms.id) {
                                        <tr>
                                            <td><a [routerLink]="['/feed', ms.dataOrigin]"
                                                    class="fw-bold text-decoration-none">{{ ms.dataOrigin }}</a></td>
                                            <td>{{ ms.name }}</td>
                                            <td class="font-monospace text-muted">{{ ms.id }}</td>
                                        </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Map Column -->
                <div class="col-lg-4">
                    <div class="map-card rounded-3 overflow-hidden shadow-sm border mb-1">
                        <div class="leaflet-map" leaflet [leafletOptions]="options" [leafletLayers]="layers"
                            [leafletLayersControl]="layersControl" (leafletMapReady)="onMapReady($event)"
                            (window:resize)="onResize()">
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted" style="font-size: 0.7rem;">
                            Last update: {{ stop.lastUpdated | date:'HH:mm' }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-xl pb-5">
        <div class="row g-4">

            <!-- RELATED STOPS -->
            @if (stop.relatedStops && stop.relatedStops.length > 0) {
            <div class="col-12">
                <h5 class="fw-bold text-muted text-uppercase small mb-3">
                    <i class="bi bi-arrow-left-right me-1"></i> Switch Transport Type / Nearby
                </h5>
                <div class="d-flex flex-wrap gap-3">
                    @for (rel of stop.relatedStops; track rel.id) {
                    <a [routerLink]="['/stops', rel.id, rel.stopType]"
                        class="related-stop-card text-decoration-none shadow-sm">
                        <div class="d-flex align-items-center gap-3 p-3">
                            <div class="icon-box rounded-circle d-flex align-items-center justify-content-center"
                                [class]="getStopTypeColor(rel.stopType) + '-bg'">
                                <i class="bi {{ getStopTypeIcon(rel.stopType) }} fs-5"></i>
                            </div>
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-dark">{{ rel.name }}</span>
                                <span class="small text-muted text-uppercase">{{ rel.stopType }}</span>
                            </div>
                            <i class="bi bi-chevron-right ms-auto text-muted"></i>
                        </div>
                    </a>
                    }
                </div>
            </div>
            }

            <!-- DEPARTURE BOARD -->
            <div class="col-12">
                <h3 class="fw-bold mb-3">Departures</h3>
                <div class="departure-board shadow-sm rounded bg-white overflow-hidden">
                    @for (trip of stop.departures; track trip.tripId; let i = $index) {
                    
                    <!-- Date Separator -->
                    @if (i > 0 && isNewDay(trip, stop.departures![i-1])) {
                    <div class="day-separator">
                        <span>{{ trip.actualArrivalTime | date:'EEEE, d MMMM' }}</span>
                    </div>
                    }

                    <a [routerLink]="['/trip', trip.tripId]"
                        class="departure-row d-flex align-items-center p-3 border-bottom text-decoration-none text-dark"
                        [class.cancelled-row]="trip.cancelled">

                        <!-- 1. Time -->
                        <div class="col-time d-flex flex-column align-items-start justify-content-center me-2">
                            @if (trip.cancelled) {
                                <span class="badge bg-danger mb-1" style="font-size: 0.6rem">Canc</span>
                                <span class="text-decoration-line-through text-muted small">{{ trip.plannedDepartureTime | date:'HH:mm' }}</span>
                            } @else {
                                <app-time-only-selection [actual]="trip.actualDepartureTime"
                                    [planned]="trip.plannedDepartureTime" [cancelled]="trip.cancelled"
                                    [scheduleRelationship]="trip.scheduleRelationship">
                                </app-time-only-selection>
                                
                                <!-- PROMINENT REALTIME INDICATOR -->
                                @if (trip.realTime) {
                                    <div class="live-indicator">
                                        <span class="pulse-dot"></span>
                                        <span class="d-none d-sm-inline">Live</span>
                                    </div>
                                }
                            }
                        </div>

                        <!-- 2. Route Badge -->
                        <div class="col-badge me-3">
                            <span class="route-pill" [style.background-color]="'#' + (trip.routeColor || '333')"
                                [style.color]="'#' + (trip.routeTextColor || 'fff')">
                                {{ trip.routeShortName }}
                            </span>
                        </div>

                        <!-- 3. Destination -->
                        <div class="col-destination flex-grow-1 text-truncate">
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <span class="fw-bold text-truncate destination-text">
                                    {{ trip.headsign || trip.stopHeadsign || trip.routeLongName }}
                                </span>
                                
                                <!-- ALTERNATIVE HEADSIGN BADGE -->
                                @if (trip.stopHeadsign && trip.stopHeadsign !== trip.headsign) {
                                    <span class="badge bg-info text-dark d-flex align-items-center gap-1 shadow-sm" 
                                          title="This text is shown on the vehicle display">
                                        <i class="bi bi-display"></i> 
                                        {{ trip.stopHeadsign }}
                                    </span>
                                }
                            </div>
                            
                            <div class="text-muted small text-truncate operator-text">
                                {{ trip.operator }}
                            </div>
                        </div>

                        <!-- 4. Platform -->
                        <div class="col-platform text-end ms-2">
                            <app-track-selection [plannedTrack]="trip.plannedPlatform"
                                [actualTrack]="trip.actualPlatform" [cancelled]="trip.cancelled"></app-track-selection>
                        </div>

                        <!-- 5. Chevron -->
                        <div class="col-action ms-3 text-muted d-none d-sm-block"><i class="bi bi-chevron-right"></i></div>
                    </a>
                    } @empty {
                    <div class="p-5 text-center text-muted">
                        <h5>No upcoming departures</h5>
                        <p>Check back later.</p>
                    </div>
                    }
                </div>
            </div>
        </div>
    </main>
    }
</div>